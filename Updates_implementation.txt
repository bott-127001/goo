Overall Implementation Strategy
We will proceed in two main phases:

Backend Refactoring: This is the most critical phase, where we'll update the core logic, data storage, and calculations. This phase will be done first, as the frontend will then consume the new data and logic.
Frontend Updates: Once the backend is producing the correct data and signals, we'll update the UI to reflect the new controls (settings) and display the new, more detailed status and signals.
Phase 1: Backend - Core Logic Engine Refactoring
This phase will involve significant changes to state.py, main.py, logic.py, calculations.py, and database.py.

1. e:\project\start-main\backend\state.py (User State Management)
Goal: Store the new baseline data and market type window setting for each user.
Changes:
Add login_timestamp: datetime.datetime to record when the user's session started.
Add baseline_set: bool (default False) to track if the baseline has been captured.
Add baseline_timestamp: datetime.datetime to store when the baseline was captured (e.g., 9:30 AM if logged in at 9:15 AM).
Add baseline_values: dict to store the Price, Delta, Gamma, and IV at the baseline timestamp.
Add market_type_window_size: int (default 3 for 15-min) to store the user's chosen market type window.
2. e:\project\start-main\backend\main.py (Scheduler & Data Flow)
Goal: Implement the delayed baseline capture and ensure the new settings are passed to the logic.
Changes:
start_user_scheduler(user_name: str):
When a user logs in and their scheduler starts, record the current time in user_state["login_timestamp"] = datetime.datetime.now().
fetch_and_store_data(user_name: str):
Delayed Baseline Capture:
After fetching the underlying_price and target option Greeks, check user_state["baseline_set"].
If user_state["baseline_set"] is False AND datetime.datetime.now() - user_state["login_timestamp"] >= datetime.timedelta(minutes=15):
Capture the underlying_price, call_greeks.get('delta'), call_greeks.get('gamma'), call_greeks.get('iv') into user_state["baseline_values"].
Set user_state["baseline_timestamp"] = datetime.datetime.now().
Set user_state["baseline_set"] = True.
run_greek_confirmation(user_name: str):
Smoothed Greeks for Entry/Exit: Instead of using the raw delta_slope, gamma_change_percent, iv_trend from the last 5-minute candle, we will call new functions from calculations.py to get the 30-60 second rolling averages for entry confirmation and 60-90 second rolling averages for emergency exit.
run_logic_controller(user_name: str):
Bias Calculation: Pass user_state["baseline_values"] and user_state["baseline_timestamp"] to the new logic.determine_bias function.
Market Type Calculation: Fetch market_type_window_size from user_state (which will come from settings) and pass it to logic.determine_market_type.
Entry Detection: The logic.detect_entry_setup will now be the "Four-Layer Entry Engine" and will require more parameters (e.g., candles_5min_buffer for BOS/Retest, smoothed Greeks).
3. e:\project\start-main\backend\logic.py (The Brains of the Operation)
Goal: Implement the new bias, market type, BOS/Retest, and layered entry/exit logic. This file will be almost entirely rewritten.
Changes:
determine_bias(...):
This function will no longer use swing_points, ema_20, etc.
It will accept current_price, current_delta, current_gamma, current_iv, and baseline_values (price, delta, gamma, iv at baseline).
Implement the Delta_from_open, Gamma_from_open, IV_from_open calculations.
Implement the new bullish/bearish bias conditions based on these _from_open values and current_price vs baseline_price.
Return "Bullish", "Bearish", or "Neutral".
determine_market_type(...):
This function will accept candles_5min_buffer and the market_type_window_size (e.g., 3 or 6).
It will calculate ATR, BodyRatio, DeltaSD, GammaChange, IVTrend over the specified window.
Implement the new "Trendy", "Volatile", "Neutral" conditions based on these calculations.
Return "Trendy", "Volatile", or "Neutral".
detect_entry_setup(...):
This will become the "Four-Layer Entry Engine".
It will accept bias, market_type, candles_5min_buffer, latest_price, smoothed_greeks (delta slope, gamma change, iv trend, theta change).
Layer 1 (Bias Check): If bias is "Neutral", return None. If bias doesn't match the potential trade direction, return None.
Layer 2 (Market Type Check):
If market_type is "Neutral", return None.
If market_type is "Trendy", proceed to look for Retest setups.
If market_type is "Volatile", proceed to look for BOS setups.
Layer 3 (Price Setup - BOS/Retest):
Call new helper functions (e.g., calculations.check_bullish_bos, calculations.check_bearish_retest) using candles_5min_buffer and latest_price.
If a valid BOS or Retest is found, proceed.
Layer 4 (Smoothed Greek Confirmation):
Check the smoothed_greeks against the thresholds defined in settings for the specific trade direction (Bullish/Bearish).
If all conditions pass, construct and return the candidate_setup.
check_exit_conditions(...):
Simplify to prioritize SL/TP.
Add the "Emergency Greek Exit" logic: Check smoothed_iv_trend and P&L (which we'll need to calculate or pass in).
4. e:\project\start-main\backend\calculations.py (New Helper Functions)
Goal: Provide the raw data processing and pattern recognition for the new logic.
Changes:
find_swing_points(candles_5min_buffer): Keep this, but ensure it's robust.
check_bullish_bos(candles_5min_buffer, buffer_pts): New function.
Identifies the previous_swing_high.
Checks if latest_close > previous_swing_high + buffer_pts.
Returns True or False, and potentially the breakout_high and breakout_low for retest calculation.
check_bearish_bos(...): Similar to bullish, but for previous_swing_low.
check_bullish_retest(candles_5min_buffer, breakout_high, breakout_low): New function.
Calculates breakout_range.
Monitors current_low_since_BOS.
Calculates retest_percent.
Returns True if 30% <= retest_percent <= 60%.
check_bearish_retest(...): Similar to bullish retest.
calculate_smoothed_delta_slope(delta_buffer, window_seconds): New function.
Takes the delta_buffer and calculates the slope over the last window_seconds (e.g., 30-60s for entry, 60-90s for exit).
calculate_smoothed_gamma_change(gamma_buffer, window_seconds): Similar for gamma.
calculate_smoothed_iv_trend(iv_buffer, window_seconds): Similar for IV.
calculate_smoothed_theta_change(theta_buffer, window_seconds): Similar for theta.
calculate_delta_stability(delta_buffer, window_size): Update to use the market_type_window_size.
calculate_body_ratio(candles_5min_buffer, window_size): Update to use the market_type_window_size.
calculate_atr(candles_5min_buffer, window_size): Update to use the market_type_window_size.
5. e:\project\start-main\backend\database.py (Settings Storage)
Goal: Store and retrieve the new configurable settings.
Changes:
Update the init_db() function to include default values for:
market_type_window_size: 3 (for 15-min)
bos_buffer_points: 10
retest_min_percent: 30
retest_max_percent: 60
New Greek thresholds for entry confirmation (e.g., entry_delta_slope_thresh, entry_gamma_change_thresh, entry_iv_trend_thresh, entry_theta_max_spike).
New Greek thresholds for emergency exit (e.g., exit_iv_crush_thresh).
Ensure get_settings() and update_setting() can handle these new keys.
Phase 2: Frontend - Updating Controls and Displays
This phase will update Settings.js, Signals.js, and Dashboard.js.

1. e:\project\start-main\frontend\src\Settings.js (User Controls)
Goal: Provide UI elements for the new configurable parameters and remove obsolete ones.
Changes:
Remove: All confirm_..., cont_..., rev_..., atr_... settings. These are now obsolete.
Add:
Market Type Window Toggle: A radio button or dropdown for "15-min (3 candles)" and "30-min (6 candles)" that updates market_type_window_size in the backend.
BOS Buffer Points: Input for bos_buffer_points.
Retest Percentage Range: Inputs for retest_min_percent and retest_max_percent.
Entry Greek Confirmation Thresholds: Inputs for entry_delta_slope_thresh, entry_gamma_change_thresh, entry_iv_trend_thresh, entry_theta_max_spike.
Emergency Exit IV Crush Threshold: Input for exit_iv_crush_thresh.
Update handleInputChange and handleSave to work with the new settings keys.
2. e:\project\start-main\frontend\src\Signals.js (Detailed Logic Display)
Goal: Visually represent the new layered logic and its current status.
Changes:
Remove: All existing biasBullishRules, biasBearishRules, marketTrendyRules, marketVolatileRules, entryContinuationRules, entryBreakoutRules, entryReversalRules. These are now obsolete.
Redesign renderChecklist: The backend will now send a more structured signals object that directly reflects the status of each layer.
New Display Sections:
Day-Open Bias Status: Show Delta_from_open, Gamma_from_open, IV_from_open, Price vs Baseline and the resulting bias.
Market Type Status: Show the market_type and the underlying metrics (ATR, BodyRatio, DeltaSD, etc.) calculated over the chosen window.
Price Action Setup: Indicate if a BOS (Bullish/Bearish) or Retest (Bullish/Bearish) is currently detected, showing the relevant price levels.
Greek Confirmation (Live): Display the smoothed_delta_slope, smoothed_gamma_change, smoothed_iv_trend, smoothed_theta_change and whether they meet the entry thresholds.
Overall Entry Trigger: A clear indicator if all 4 layers are green for a trade.
3. e:\project\start-main\frontend\src\Dashboard.js (High-Level Overview)
Goal: Display the high-level bias and market_type from the new backend logic.
Changes:
No major structural changes needed here, as it already consumes data.bias and data.market_type from the WebSocket. These values will simply be more accurate and stable due to the backend changes.
The SystemStatus component will continue to display these.
This plan provides a clear roadmap. We can tackle these changes systematically, starting with the backend modifications, which are foundational.